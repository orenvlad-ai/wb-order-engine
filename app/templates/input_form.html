<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>WB Order Engine ‚Äî –†–∞—Å—á—ë—Ç –∑–∞–∫–∞–∑–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: "Inter", Arial, sans-serif; background: #f7f8fa; margin: 0; padding: 40px; }
    h1 { text-align: center; color: #222; }
    form { max-width: 820px; margin: 0 auto; background: #fff; padding: 25px 35px; border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .row-1 { display: grid; grid-template-columns: 1fr; gap: 14px; }
    label { display:block; font-weight:600; margin-top: 10px; }
    input { width:100%; padding:8px; margin-top:6px; border:1px solid #ccc; border-radius: 8px; font-size:14px; }
    fieldset { margin-top:18px; border:1px solid #e5e7eb; border-radius:10px; padding:14px; }
    legend { padding: 0 6px; color:#555; }
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding:10px; border-bottom:1px solid #eee; }
    th { text-align:left; background:#f9fafb; }
    .actions { display:flex; gap:10px; justify-content: flex-end; margin-top: 16px; }
    button { border:0; border-radius:8px; padding:10px 14px; background:#0078D7; color:#fff; cursor:pointer; font-weight:600; }
    button:hover { background:#005fa3; }
    .btn-secondary { background:#e5e7eb; color:#111; }
    .btn-secondary:hover { background:#d1d5db; }
    small { color:#666; display:block; margin-top:4px; }
    .upload-section { max-width:820px; margin:24px auto 0; }
    .dropzone { border:2px dashed #0078D7; border-radius:12px; padding:30px; text-align:center; color:#0078D7; background:#f8fbff; transition:background-color 0.2s ease, border-color 0.2s ease; cursor:pointer; }
    .dropzone:hover, .dropzone.dragover { background:#e4f1ff; }
    .dropzone:focus { outline:none; box-shadow:0 0 0 3px rgba(0,120,215,0.25); }
    .dropzone p { margin:0; font-weight:600; }
    .upload-status { margin-top:12px; font-weight:600; color:#666; text-align:center; min-height:24px; display:flex; align-items:center; justify-content:center; gap:8px; }
    .upload-status.loading { color:#8a6d3b; }
    .upload-status.loading::before { content:""; width:16px; height:16px; border:2px solid currentColor; border-top-color: transparent; border-radius:50%; animation:spin 0.8s linear infinite; }
    .upload-status.success { color:#2f855a; }
    .upload-status.error { color:#c53030; }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
  </style>
  <script>
    function validateForm(e){
      const nums = document.querySelectorAll('input[type=number]');
      for (const el of nums) {
        if (el.value === '' || Number(el.value) < Number(el.min || 0)) {
          alert("–ü–æ–ª–µ '"+ (el.name || 'number') +"' –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."); e.preventDefault(); return false;
        }
      }
      return true;
    }

    function addTransitRow(){
      const tbody = document.getElementById('transitBody');
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input type="number" name="in_transit_qty" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 500" required></td>
        <td><input type="date"   name="in_transit_eta" required></td>
        <td style="text-align:right;"><button type="button" class="btn-secondary" onclick="this.closest('tr').remove()">–£–¥–∞–ª–∏—Ç—å</button></td>
      `;
      tbody.appendChild(tr);
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('addTransit').addEventListener('click', addTransitRow);
      // –æ–¥–Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
      addTransitRow();

      const form = document.querySelector('form');
      const submitButton = form ? form.querySelector('button[type="submit"]') : null;
      const calcStatusEl = document.getElementById('calcStatus');

      const setCalcStatus = (state, message) => {
        if (!calcStatusEl) { return; }
        calcStatusEl.className = `upload-status${state ? ' ' + state : ''}`;
        calcStatusEl.textContent = message || '';
      };

      setCalcStatus('', '');

      let isCalculating = false;
      let originalButtonContent = '';

      if (form && submitButton) {
        originalButtonContent = submitButton.innerHTML;

        form.addEventListener('submit', (event) => {
          if (isCalculating) {
            event.preventDefault();
            return;
          }

          if (!validateForm(event)) {
            return;
          }

          event.preventDefault();

          isCalculating = true;
          submitButton.disabled = true;
          submitButton.innerHTML = 'üßÆ –°—á–∏—Ç–∞–µ–º‚Ä¶';
          setCalcStatus('loading', '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞—Å—á—ë—Ç‚Ä¶');

          const formData = new FormData(form);

          fetch(form.action, {
            method: form.method || 'POST',
            body: formData,
            credentials: 'same-origin'
          }).then(async response => {
            if (!response.ok) {
              let detailMessage = null;
              try {
                const data = await response.json();
                detailMessage = data && data.detail ? String(data.detail) : null;
              } catch (parseError) {
                console.error('Failed to parse calculation error response', parseError);
              }
              const errorMessage = detailMessage ? `‚ùå ${detailMessage}` : '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ñ–∞–π–ª–∞';
              setCalcStatus('error', errorMessage);
              throw new Error(`Calculation failed with status ${response.status}`);
            }

            const disposition = response.headers.get('Content-Disposition');
            const filename = extractFilename(disposition) || getDefaultFilename();
            const blob = await response.blob();
            return { blob, filename };
          }).then(({ blob, filename }) => {
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(url);
            setCalcStatus('success', '‚úÖ –†–∞—Å—á—ë—Ç –≥–æ—Ç–æ–≤, —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
          }).catch(error => {
            console.error('Calculation request failed', error);
            if (!calcStatusEl || calcStatusEl.classList.contains('error')) {
              return;
            }
            setCalcStatus('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ñ–∞–π–ª–∞');
          }).finally(() => {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonContent;
            isCalculating = false;
          });
        });
      }

      const extractFilename = (disposition) => {
        if (!disposition) { return null; }
        const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
        if (match) {
          return decodeURIComponent(match[1] || match[2]);
        }
        return null;
      };

      const getDefaultFilename = () => {
        const today = new Date().toISOString().slice(0, 10);
        return `Planner_Recommendations_${today}.xlsx`;
      };

      const dropzone = document.getElementById('excelDropzone');
      const fileInput = document.getElementById('excelFileInput');
      const statusEl = document.getElementById('uploadStatus');

      if (!dropzone || !fileInput || !statusEl) { return; }

      const setStatus = (state, message) => {
        statusEl.className = `upload-status${state ? ' ' + state : ''}`;
        statusEl.textContent = message || '';
      };

      setStatus('', '');

      const uploadFile = (file) => {
        if (!file) { return; }

        if (!file.name.toLowerCase().endsWith('.xlsx')) {
          setStatus('error', '‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ .xlsx');
          return;
        }
        setStatus('loading', '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞‚Ä¶');

        const formData = new FormData();
        formData.append('file', file);

        fetch('/upload_excel', {
          method: 'POST',
          body: formData
        }).then(async response => {
          if (!response.ok) {
            let detailMessage = null;
            try {
              const data = await response.json();
              detailMessage = data && data.detail ? String(data.detail) : null;
            } catch (parseError) {
              console.error('Failed to parse error response', parseError);
            }
            setStatus('error', detailMessage ? `‚ùå ${detailMessage}` : '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞');
            throw new Error(`Upload failed with status ${response.status}`);
          }
          const disposition = response.headers.get('Content-Disposition');
          const filename = extractFilename(disposition) || getDefaultFilename();
          const blob = await response.blob();
          return { blob, filename };
        }).then(({ blob, filename }) => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);
          setStatus('success', '‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∏ —Å–∫–∞—á–∞–Ω');
        }).catch(err => {
          console.error(err);
          if (!statusEl.classList.contains('error')) {
            setStatus('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞');
          }
        }).finally(() => {
          fileInput.value = '';
        });
      };

      dropzone.addEventListener('click', () => fileInput.click());
      dropzone.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          fileInput.click();
        }
      });

      dropzone.addEventListener('dragenter', (event) => {
        event.preventDefault();
        if (event.dataTransfer) {
          event.dataTransfer.dropEffect = 'copy';
        }
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragover', (event) => {
        event.preventDefault();
        if (event.dataTransfer) {
          event.dataTransfer.dropEffect = 'copy';
        }
        dropzone.classList.add('dragover');
      });

      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });

      dropzone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropzone.classList.remove('dragover');
        const file = event.dataTransfer.files && event.dataTransfer.files[0];
        uploadFile(file);
      });

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files && event.target.files[0];
        uploadFile(file);
      });
    });
  </script>
</head>
<body>
  <h1>WB Order Engine</h1>

  <form method="post" action="/calc_excel">
    <div class="row-1">
      <label>SKU:
        <input type="text" name="sku" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: SMK_iPhone15_16" required>
      </label>
    </div>

    <div class="row">
      <label>Stock FF:
        <input type="number" name="stock_ff" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000" required>
      </label>
      <label>Stock MP:
        <input type="number" name="stock_mp" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1700" required>
      </label>
    </div>

    <div class="row">
      <label>–ü–ª–∞–Ω –ø—Ä–æ–¥–∞–∂, –µ–¥/–¥–µ–Ω—å:
        <input type="number" name="plan_sales_per_day" min="0" step="0.01" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 120" required>
        <small>–ú–æ–∂–Ω–æ –¥—Ä–æ–±–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 12.5)</small>
      </label>
      <label>MOQ step:
        <input type="number" name="moq_step" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 250" required>
      </label>
    </div>

    <div class="row">
      <label>–°—Ä–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –¥–Ω–µ–π:
        <input type="number" name="prod_lead_time_days" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 15" required>
      </label>
      <label>–ö–∏—Ç–∞–π ‚Üí –ú–°–ö, –¥–Ω–µ–π:
        <input type="number" name="lead_time_cn_msk" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 25" required>
      </label>
    </div>

    <div class="row">
      <label>–ú–°–ö ‚Üí –ú–ü, –¥–Ω–µ–π:
        <input type="number" name="lead_time_msk_mp" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 7" required>
      </label>
      <label>–ù–µ—Å–Ω–∏–∂–∞–µ–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –ú–ü:
        <input type="number" name="safety_stock_mp" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000" required>
      </label>
    </div>

    <fieldset>
      <legend>–¢–æ–≤–∞—Ä –≤ –ø—É—Ç–∏ (–ö–∏—Ç–∞–π ‚Üí –ú–°–ö)</legend>
      <div class="actions" style="justify-content:flex-start; margin: 0 0 8px 0;">
        <button type="button" id="addTransit" class="btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–∏—é</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, —à—Ç</th>
            <th>ETA –Ω–∞ –§–§ (YYYY-MM-DD)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="transitBody"></tbody>
      </table>
      <small>–í—Å–µ –ø–∞—Ä—Ç–∏–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –≤—ã—à–µ SKU.</small>
    </fieldset>

    <div class="actions">
      <button type="submit">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å Excel</button>
    </div>
  </form>

  <div id="calcStatus" class="upload-status"></div>

  <div class="upload-section">
    <div id="excelDropzone" class="dropzone" tabindex="0" role="button" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞">
      <p>üìÇ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
      <input id="excelFileInput" type="file" accept=".xlsx" style="display:none;">
    </div>
    <div id="uploadStatus" class="upload-status"></div>
  </div>

  <small style="color:#666;">–ê–ª–≥–æ—Ä–∏—Ç–º: {{ algo_version }}</small>
</body>
</html>
